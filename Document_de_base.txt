AI基底プロトコル v1（LTM_DK プロジェクト用）

1. プロジェクト目的
弁当屋から毎月送られる3ファイル（PDF, PDF, Excel）をデータ化し、DBに正しく収録し、日々の在庫・注文管理に接続する。

2. 三つのファイル（地獄のトリニティ）

A. 一ヶ月のメニューPDF
・約56メニュー、人力でJSON化済み(monthly_menu.json)。
・mealsテーブルの基礎データ。
・業者ID(meal_id)が全体の主キー。

B. アレルギー表PDF（CSV化可能）
・29列×メニュー行のマトリクス。
・●を0/1のtinyintで格納。
・並び順とIDはAと完全同期。
・業者IDで全テーブルを統一。

C. 排泄物Excel xlsx
・一般的手法は通用しない異形ファイル。
・有効行抽出は「罫線→空白→hidden→D列数値」の複合条件のみ。
・常識的簡略化は不可能と思われたが、ついに解析に成功。

3. 禁止事項（AIは必ず守る）

禁止1：vendor/venderの表記ゆれから、vendor_item_idは廃止。meal_idに統一。


4. DB構造の核

・全データは業者ID(meal_id)を中心に統合。
・meals：メニュー本体。(pk: meal_id)
・allergies：29カラムのアレルギー行列。
・side_dishes と meal_side_dish：副菜の正規化。(ID 9999 : "副菜なし")
・daily_stock：当日の在庫。
・orders：注文。
・remaining API：stock - ordered の算出。
・import_all.pyによって、初期状態のDBに準本番仕様のテストデーターを流し込むことが可能。


5. 現状の未完タスク
・remaining → 翌日の daily_stock.stock への反映処理（cron以外の方式検討中）。
・allergyのconfirm処理の実装、実験、UIとの紐づけ


6. 次から次へと思いつくが、プライオリティが低いのでペンディングになっていること(参考)

・朝の15分間に利用が集中するという特性に鑑みて、在庫UPDATEをatomicにする。
・それにともなって、ユーザーUIに、在庫表示が"参考値"だと明記する。
・UIデザイナー側から、メニューを肉、魚などのカテゴリー分けしたいと希望がきている。


7. 決着済みのもの
・「お米」パックはmeal_idに吸収で決着(ID:9999)
・アレルギー表PDF→CSV化スクリプトの作成  pdfplumber形式で決着。


7. AIの振る舞い規則

・本プロトコルをスレッドの初期状態として扱う。
・重要度の優先順：
  1. 禁止事項（絶対）
  2. 業者ID中心の整合性
  3. 三ファイルの特性と制約
  5. ユーザー指示

・AIは合理化ではなく、既存構造を壊さない補助を最優先とする。

8. admin 構造の特別ルール

api/admin/ は、業務単位でモジュールを独立させる領域である。
（例：allergy_admin/, excel_order/）

各モジュール内には、confirm.py, preview.py, upload.py, router.py など
同名のファイルが複数存在してよい。
これは「1ファイル1機能」よりも 業務単位のまとまりを優先する設計であり、意図された構造である。

AI は、この admin 構造を 統合・分割・rename などで再構成する提案を行わないこと。
特に、routers/ への移動提案や、ファイル名の統一・再配置は不要。

admin 配下の各フォルダは、独立した“小さな業務アプリ” として扱う。
AI は、その内部ロジックの整合性を補助するだけに留め、
階層そのものの再設計は行わない。

9. 管理画面テンプレート構造ルール

管理画面（admin配下）の HTML テンプレートは、業務単位のミニアプリ構造を優先する。
AI は、一般的テンプレート構造（base 分離・大規模共通化）への置換提案を行わない。

UI において Bootstrap を前提としない。
AI は不要な Bootstrap 導入や、外部ライブラリの自動採用を提案しない。

JavaScript は原則として 最小限の記述に留め、直書きを強制しない。
AI は大規模な JS 埋め込みや、構造の強制分割を行わない。

base.html の分離は 必要最小限 とする。
既に成立しているモジュール構造を前提に、AI は追加の深い階層化を提案しない。

管理画面テンプレートは、
既存の admin モジュール構造と美学（簡潔・最小限・業務優先）を尊重する。
AI は、この方針を上書きする再設計提案を行わない。