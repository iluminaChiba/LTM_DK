{% extends "admin/base.html" %}

{% block content %}
<h2>新規メニュー登録</h2>

<p class="text-muted">
  アレルギー表に新しく登場したメニューです。<br>
  一か月メニュー表を確認し、正式な料理名を入力してください。
</p>

{% if new_meal_ids|length == 0 %}
  <div class="alert alert-info">
    現在、登録が必要な新規メニューはありません。
  </div>
{% else %}

<form id="meal-register-form">
  <table class="table table-bordered table-sm">
    <thead>
      <tr>
        <th style="width: 80px;">ID</th>
        <th>正式名称（必須）</th>
        <th>ふりがな</th>
        <th>栄養価（任意）</th>
      </tr>
    </thead>
    <tbody>
    {% for mid in new_meal_ids %}
      <tr>
        <td>{{ mid }}</td>

        <!-- 正式名称 -->
        <td>
          <input type="text"
                 name="items[{{ loop.index0 }}][meal_name]"
                 class="form-control"
                 required>
          <input type="hidden"
                 name="items[{{ loop.index0 }}][meal_id]"
                 value="{{ mid }}">
        </td>

        <!-- ふりがな -->
        <td>
          <input type="text"
                 name="items[{{ loop.index0 }}][furigana]"
                 class="form-control">
        </td>

        <!-- 栄養価（任意） -->
        <td>
          <div class="d-flex flex-wrap gap-1">
            <label class="small">kcal</label>
            <input type="number" step="0.1" name="items[{{ loop.index0 }}][kcal]" class="form-control form-control-sm" style="width:70px;">

            <label class="small">タンパク質</label>
            <input type="number" step="0.1" name="items[{{ loop.index0 }}][protein]" class="form-control form-control-sm" style="width:70px;">

            <label class="small">脂質</label>
            <input type="number" step="0.1" name="items[{{ loop.index0 }}][fat]" class="form-control form-control-sm" style="width:70px;">

            <label class="small">炭水化物</label>
            <input type="number" step="0.1" name="items[{{ loop.index0 }}][carb]" class="form-control form-control-sm" style="width:70px;">

            <label class="small">塩分</label>
            <input type="number" step="0.1" name="items[{{ loop.index0 }}][salt]" class="form-control form-control-sm" style="width:70px;">
          </div>
        </td>
      </tr>
    {% endfor %}
    </tbody>
  </table>

  <div class="text-end mt-3">
    <button type="button" id="submit-btn" class="btn btn-primary">
      登録する
    </button>
  </div>
</form>

<!-- 送信用スクリプト -->
<script>
document.getElementById("submit-btn").addEventListener("click", async () => {

  const formEl = document.getElementById("meal-register-form");
  const formData = new FormData(formEl);

  // FormData → JSON 化
  const payload = { items: [] };
  const indexSet = new Set();

  for (let [key, value] of formData.entries()) {
      const match = key.match(/items\[(\d+)\]\[(.+)\]/);
      if (!match) continue;

      const idx = match[1];
      const field = match[2];
      indexSet.add(idx);

      if (!payload.items[idx]) payload.items[idx] = {};
      payload.items[idx][field] = value;
  }

  // 数値変換（空欄は除外）
  payload.items = payload.items.map(item => {
      ["kcal","protein","fat","carb","salt"].forEach(f => {
          if (item[f] === "") delete item[f];
          else item[f] = parseFloat(item[f]);
      });
      item.meal_id = parseInt(item.meal_id);
      return item;
  });

  const res = await fetch("/admin/meals/bulk", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
  });

  if (res.ok) {
      alert("メニューを登録しました。");
      location.reload();
  } else {
      const err = await res.json();
      alert("エラー: " + err.detail);
  }
});
</script>

{% endif %}

{% endblock %}
