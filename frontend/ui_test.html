<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <title>今日のランチを選ぶ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 16px;
      background: #f5f5f5;
    }

    .page {
      max-width: 480px;
      margin: 0 auto;
    }

    h1 {
      font-size: 20px;
      margin-bottom: 8px;
      text-align: center;
    }

    p.description {
      font-size: 14px;
      color: #555;
      text-align: center;
      margin-bottom: 16px;
    }

    .menu-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 16px;
    }

    .menu-button {
      padding: 16px;
      border-radius: 8px;
      border: none;
      width: 100%;
      font-size: 16px;
      text-align: left;
      box-sizing: border-box;
      background: #ffffff;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12);
      cursor: pointer;
    }

    .menu-button strong {
      display: block;
      margin-bottom: 4px;
    }

    .menu-button:active {
      transform: scale(0.98);
    }

    .menu-button[disabled] {
      opacity: 0.6;
      cursor: default;
      transform: none;
    }

    .status {
      font-size: 14px;
      text-align: center;
      min-height: 1.5em;
    }

    .status--ok {
      color: #2e7d32;
    }

    .status--error {
      color: #c62828;
    }
  </style>
</head>

<body>
  <div class="page">
    <h1>今日のランチを選んでください</h1>
    <p class="description">ボタンをひとつだけ押してください。</p>

    <div class="menu-list">
      <button class="menu-button js-menu-button" data-menu-id="1">
        <strong>Aランチ</strong>
        <span>ハンバーグ弁当</span>
      </button>

      <button class="menu-button js-menu-button" data-menu-id="2">
        <strong>Bランチ</strong>
        <span>焼き魚弁当</span>
      </button>

      <button class="menu-button js-menu-button" data-menu-id="3">
        <strong>Cランチ</strong>
        <span>カレーライス</span>
      </button>
    </div>

    <div id="status" class="status"></div>
  </div>

  <script>
    const API_ENDPOINT = "/api/uitest"; // テスト用APIエンドポイント
    const token = getTokenFromUrl();
    const statusEl = document.getElementById("status");
    const buttons = Array.from(document.querySelectorAll(".js-menu-button"));
    // token がない場合はエラーメッセージを表示してボタンを無効化
    if (!token) {
      statusEl.textContent = "URLが正しくありません。（token が見つかりません）";
      statusEl.classList.add("status--error");
      buttons.forEach(b => b.disabled = true);
    }
    // 各ボタンにクリックイベントを設定
    buttons.forEach(btn => {
      btn.addEventListener("click", async () => {
        if (!token) return;

        const menuId = btn.dataset.menuId;

        setLoading(true);
        statusEl.textContent = "登録しています…";
        statusEl.classList.remove("status--ok", "status--error");

        try {
          await postMealLog(menuId);
          statusEl.textContent = "登録しました。ありがとうございました。";
          statusEl.classList.add("status--ok");
        } catch (e) {
          console.error(e);
          statusEl.textContent = "登録に失敗しました。時間をおいて再度お試しください。";
          statusEl.classList.add("status--error");
          setLoading(false); // 失敗時は再入力できるようにする
        }
      });
    });
    // 食事ログを登録する関数
    async function postMealLog(menuId) {
      const payload = {
        menu_id: menuId,
        taken_at: new Date().toISOString(), // 使うなら FastAPI 側と要相談
      };

      const res = await fetch(API_ENDPOINT, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          // ここは実際の認証仕様に合わせる
          "X-Auth-Token": token,
        },
        body: JSON.stringify(payload),
      });

      if (!res.ok) {
        throw new Error("HTTP " + res.status);
      }

      return await res.json().catch(() => null);
    }
    // URL パラメータから token を取得するヘルパー関数
    function getTokenFromUrl() {
      const params = new URLSearchParams(window.location.search);
      return params.get("token");
    }
    // ローディング状態の切り替え
    function setLoading(loading) {
      buttons.forEach(btn => btn.disabled = loading);
    }
  </script>
</body>

</html>